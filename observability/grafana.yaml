apiVersion: v1
kind: ConfigMap
metadata: { name: grafana-datasources }
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus.default.svc.cluster.local:9090
      isDefault: true
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: grafana }
spec:
  replicas: 1
  selector: { matchLabels: { app: grafana } }
  template:
    metadata: { labels: { app: grafana } }
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:10.4.5
        ports: [{ containerPort: 3000 }]
        env:
        - { name: GF_SECURITY_ADMIN_USER, value: admin }
        - { name: GF_SECURITY_ADMIN_PASSWORD, value: admin }
        volumeMounts:
        - { name: datasources, mountPath: /etc/grafana/provisioning/datasources }
        resources:
          requests: { cpu: "100m", memory: "128Mi" }
          limits:   { cpu: "500m", memory: "512Mi" }
      volumes:
      - name: datasources
        configMap: { name: grafana-datasources }
---
apiVersion: v1
kind: Service
metadata: { name: grafana }
spec:
  type: NodePort
  selector: { app: grafana }
  ports:
  - { name: http, port: 3000, targetPort: 3000, nodePort: 32000 }
