apiVersion: batch/v1
kind: Job
metadata:
  name: integration-tests
spec:
  backoffLimit: 0
  template:
    spec:
      containers:
      - name: integration-tests
        image: curlimages/curl:8.5.0
        command:
        - sh
        - -c
        - |
          echo "Starting integration health checks..."

          check_service() {
            svc=$1
            port=$2
            path=$3
            echo "Checking $svc on port $port ..."
            code=$(curl -s -o /dev/null -w "%{http_code}" http://$svc:$port$path || echo "000")
            if [ "$code" != "200" ]; then
              echo "$svc failed health check at $path (got $code)"
              exit 1
            else
              echo "$svc is healthy"
            fi
          }

          # Run checks
          check_service frontend 8080 /
          check_service game-service 8081 /healthz
          check_service order-service 8082 /healthz
          check_service analytics-service 8083 /healthz
          check_service clickhouse 8084 /

          echo "All services passed health checks."
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi
      restartPolicy: Never
