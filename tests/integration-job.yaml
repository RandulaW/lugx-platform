apiVersion: batch/v1
kind: Job
metadata:
  name: integration-tests
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: tester
          image: curlimages/curl:8.8.0
          command: ["/bin/sh","-lc"]
          args:
            - |
              set -eux

              # Simple retry helper
              retry() {
                url=$1
                expected=$2
                for i in $(seq 1 10); do
                  code=$(curl -s -o /dev/null -w "%{http_code}" "$url" || true)
                  echo "$url -> $code (try $i)"
                  if [ "$code" = "$expected" ]; then
                    return 0
                  fi
                  sleep 5
                done
                return 1
              }

              fail=0

              echo "=== Healthz ==="
              retry http://game-service-svc.default.svc.cluster.local/healthz 200 || fail=1
              retry http://order-service-svc.default.svc.cluster.local/healthz 200 || fail=1
              retry http://analytics-service-svc.default.svc.cluster.local/healthz 200 || fail=1
              retry http://lugx-service.default.svc.cluster.local/ 200 || fail=1

              echo "=== Functional Checks ==="
              # Game-service GET only
              retry http://game-service-svc.default.svc.cluster.local/games 200 || fail=1

              # Order-service GET only
              retry http://order-service-svc.default.svc.cluster.local/orders 200 || fail=1

              # Analytics-service GET only
              retry http://analytics-service-svc.default.svc.cluster.local/events 200 || fail=1

              exit $fail
